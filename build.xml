<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Usage" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildBinPath)\Microsoft.CSharp.targets" />

  <UsingTask TaskName="Xunit" AssemblyFile="project/Conduit.Build.Targets/bin/Debug/Conduit.Build.Targets.dll" />
  <UsingTask TaskName="List" AssemblyFile="project/Conduit.Build.Targets/bin/Debug/Conduit.Build.Targets.dll" />
  <UsingTask TaskName="Glob" AssemblyFile="project/Conduit.Build.Targets/bin/Debug/Conduit.Build.Targets.dll" />
  <UsingTask TaskName="Xunit.Runner.MSBuild.xunit" AssemblyFile="packages/xunit.runner.msbuild.2.1.0-beta4-build3109/build/portable-net45+netcore45+wp8+wpa81/xunit.runner.msbuild.dll"/> <!-- https://xunit.github.io/docs/running-tests-in-msbuild.html -->

  <Target Name="Build">
    <MsBuild Projects="$(MSBuildProjectDirectory)\Conduit.sln" Targets="rebuild"/>
  </Target>
  
  <ItemGroup>
    <TestAssemblies Include="**\*Unit.Tests.dll" />
  </ItemGroup>
    
  <Target Name="Usage">
    <CallTarget Targets="ListTargets"/>
  </Target>

  <Target Name="ListTargets">
    <List />
  </Target>
  
  <Target Name="HACK-CopyXunitAssemblies" Condition="Exists('C:/Program Files (x86)/MSBuild/14.0/Bin')">
    <Copy SourceFiles="packages/xunit.runner.utility.2.1.0/lib/net35/xunit.runner.utility.desktop.dll" DestinationFolder="C:/Program Files (x86)/MSBuild/14.0/Bin" />
    <Copy SourceFiles="packages/xunit.abstractions.2.0.0/lib/net35/xunit.abstractions.dll" DestinationFolder="C:/Program Files (x86)/MSBuild/14.0/Bin" />
  </Target>

  <PropertyGroup>
    <Reporter>verbose</Reporter>
  </PropertyGroup>
  
  <Target Name="TestUnit">
    <ItemGroup>
      <!-- [https://msdn.microsoft.com/en-us/library/ms164283.aspx]
           Might be able to do this all with file selecting, but it then means duplicating all that logic in every file -->
      <TestAssemblies Include="**\bin\**\Conduit.Unit.Tests.dll" /> <!-- This returns every match -->
    </ItemGroup>

    <!--
        This finds exactly one match because it selects the last modified.
        I wonder if this could accept a list of files and just return the last modified one, which would remove the globbing
        responsibility
    -->
    <Glob Pattern=".\**\bin\**\Conduit.Unit.Tests.dll"><!-- This returns the last modified match -->
      <Output TaskParameter="Path" PropertyName="Path" />
    </Glob>

    <Xunit.Runner.MSBuild.xunit Assemblies="$(Path)" ShadowCopy="false" Reporter="$(Reporter)"/>
  </Target>

  <Target Name="TestIntegration">
    <Glob Pattern=".\**\bin\**\Conduit.Integration.Tests.dll">
      <Output TaskParameter="Path" PropertyName="Path" />
    </Glob>

    <Xunit.Runner.MSBuild.xunit Assemblies="$(Path)" ShadowCopy="false" Reporter="$(Reporter)"/>
  </Target>

  <Target Name="CustomTestUnit" Label="This one uses custome xunit runner">
    <!-- http://stackoverflow.com/questions/690432/how-to-solve-custom-msbuild-task-requires-assembly-outside-of-appbase -->
    <!-- 
    Forced to do this at least temporarily because otherwise MsBuild fails to load <xunit.runner.utility.desktop.dll>: 

    *** Assembly Binder Log Entry  (22/02/2016 @ 3:45:20 p.m.) ***

    The operation failed.
    Bind result: hr = 0x80070002. The system cannot find the file specified.

    Assembly manager loaded from:  C:\Windows\Microsoft.NET\Framework\v4.0.30319\clr.dll
    Running under executable  c:\Program Files (x86)\MSBuild\14.0\Bin\MSBuild.exe
    A detailed error log follows. 

    === Pre-bind state information ===
    LOG: DisplayName = xunit.runner.utility.desktop, Version=2.1.0.3179, Culture=neutral, PublicKeyToken=8d05b1bb7a6fdb6c
     (Fully-specified)
    LOG: Appbase = file:///c:/Program Files (x86)/MSBuild/14.0/Bin/
    LOG: Initial PrivatePath = NULL
    LOG: Dynamic Base = NULL
    LOG: Cache Base = NULL
    LOG: AppName = MSBuild.exe
    Calling assembly : (Unknown).
    ===
    LOG: This bind starts in default load context.
    LOG: Using application configuration file: c:\Program Files (x86)\MSBuild\14.0\Bin\MSBuild.exe.Config
    LOG: Using host configuration file: 
    LOG: Using machine configuration file from C:\Windows\Microsoft.NET\Framework\v4.0.30319\config\machine.config.
    LOG: GAC Lookup was unsuccessful.
    LOG: Attempting download of new URL file:///c:/Program Files (x86)/MSBuild/14.0/Bin/xunit.runner.utility.desktop.DLL.
    LOG: Attempting download of new URL file:///c:/Program Files (x86)/MSBuild/14.0/Bin/xunit.runner.utility.desktop/xunit.runner.utility.desktop.DLL.
    LOG: Attempting download of new URL file:///c:/Program Files (x86)/MSBuild/14.0/Bin/xunit.runner.utility.desktop.EXE.
    LOG: Attempting download of new URL file:///c:/Program Files (x86)/MSBuild/14.0/Bin/xunit.runner.utility.desktop/xunit.runner.utility.desktop.EXE.
    LOG: All probing URLs attempted and failed.
    -->
    <Glob Pattern=".\**\bin\**\Conduit.Unit.Tests.dll">
      <Output TaskParameter="Path" PropertyName="Path" />
    </Glob>
    
    <Message Text="Found this assembly file file $(Path)" />

    <CallTarget Targets="HACK-CopyXunitAssemblies" />
    <Xunit TestAssemblyGlob=".\**\bin\**\Conduit.Unit.Tests.dll" />
  </Target>

  <Target Name="CustomTestIntegration" Label="This one uses custome xunit runner">
    <CallTarget Targets="HACK-CopyXunitAssemblies" />
    <Xunit TestAssemblyGlob=".\**\bin\**\Conduit.Integration.Tests.dll" />
  </Target>

  <Target Name="TestAll">
    <CallTarget Targets="TestUnit;TestIntegration"/>
  </Target>

  <Target Name="BuildStatus">
    <Exec Command="curl https://ci.appveyor.com/api/projects/ben-biddington/Conduit -H 'Authorization: Bearer `cat .token`' | python -m json.tool" />
  </Target>
</Project>
