<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Usage" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildBinPath)\Microsoft.CSharp.targets" />

  <UsingTask TaskName="Xunit" AssemblyFile="project/Conduit.Build.Targets/bin/Debug/Conduit.Build.Targets.dll" />
  <UsingTask TaskName="List" AssemblyFile="project/Conduit.Build.Targets/bin/Debug/Conduit.Build.Targets.dll" />
  
  <Target Name="Usage">
    <CallTarget Targets="ListTargets"/>
  </Target>

  <Target Name="ListTargets">
    <List />
  </Target>
  
  <Target Name="HACK-CopyXunitAssemblies" Condition="Exists('C:/Program Files (x86)/MSBuild/14.0/Bin')">
    <Copy SourceFiles="packages/xunit.runner.utility.2.1.0/lib/net35/xunit.runner.utility.desktop.dll" DestinationFolder="C:/Program Files (x86)/MSBuild/14.0/Bin" />
    <Copy SourceFiles="packages/xunit.abstractions.2.0.0/lib/net35/xunit.abstractions.dll" DestinationFolder="C:/Program Files (x86)/MSBuild/14.0/Bin" />
  </Target>
  
  <Target Name="TestUnit" Label="Run unit tests">
    <!-- http://stackoverflow.com/questions/690432/how-to-solve-custom-msbuild-task-requires-assembly-outside-of-appbase -->
    <!-- 
    Forced to do this at least temporarily because otherwise MsBuild fails to load <xunit.runner.utility.desktop.dll>: 

    *** Assembly Binder Log Entry  (22/02/2016 @ 3:45:20 p.m.) ***

    The operation failed.
    Bind result: hr = 0x80070002. The system cannot find the file specified.

    Assembly manager loaded from:  C:\Windows\Microsoft.NET\Framework\v4.0.30319\clr.dll
    Running under executable  c:\Program Files (x86)\MSBuild\14.0\Bin\MSBuild.exe
    A detailed error log follows. 

    === Pre-bind state information ===
    LOG: DisplayName = xunit.runner.utility.desktop, Version=2.1.0.3179, Culture=neutral, PublicKeyToken=8d05b1bb7a6fdb6c
     (Fully-specified)
    LOG: Appbase = file:///c:/Program Files (x86)/MSBuild/14.0/Bin/
    LOG: Initial PrivatePath = NULL
    LOG: Dynamic Base = NULL
    LOG: Cache Base = NULL
    LOG: AppName = MSBuild.exe
    Calling assembly : (Unknown).
    ===
    LOG: This bind starts in default load context.
    LOG: Using application configuration file: c:\Program Files (x86)\MSBuild\14.0\Bin\MSBuild.exe.Config
    LOG: Using host configuration file: 
    LOG: Using machine configuration file from C:\Windows\Microsoft.NET\Framework\v4.0.30319\config\machine.config.
    LOG: GAC Lookup was unsuccessful.
    LOG: Attempting download of new URL file:///c:/Program Files (x86)/MSBuild/14.0/Bin/xunit.runner.utility.desktop.DLL.
    LOG: Attempting download of new URL file:///c:/Program Files (x86)/MSBuild/14.0/Bin/xunit.runner.utility.desktop/xunit.runner.utility.desktop.DLL.
    LOG: Attempting download of new URL file:///c:/Program Files (x86)/MSBuild/14.0/Bin/xunit.runner.utility.desktop.EXE.
    LOG: Attempting download of new URL file:///c:/Program Files (x86)/MSBuild/14.0/Bin/xunit.runner.utility.desktop/xunit.runner.utility.desktop.EXE.
    LOG: All probing URLs attempted and failed.
    -->
    <CallTarget Targets="HACK-CopyXunitAssemblies" />
    <Xunit TestAssembly="project/Conduit.Unit.Tests/bin/Debug/Conduit.Unit.Tests.dll" />
  </Target>

  <Target Name="TestIntegration">
    <CallTarget Targets="HACK-CopyXunitAssemblies" />
    <Xunit TestAssembly="project/Conduit.Integration.Tests/bin/Debug/Conduit.Integration.Tests.dll" />
  </Target>

  <Target Name="TestAll">
    <CallTarget Targets="TestUnit;TestIntegration"/>
  </Target>

  <Target Name="BuildStatus">
    <Exec Command="curl https://ci.appveyor.com/api/projects/ben-biddington/Conduit -H 'Authorization: Bearer `cat .token`' | python -m json.tool" />
  </Target>
</Project>
